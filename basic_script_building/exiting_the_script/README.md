### 退出脚本

shell 中运行的每个命令都使用退出状态码来告诉 shell 自己已经运行完毕。
退出状态码是一个 0～255 的整数值，在命令结束运行时由其传给 shell。
你可以获取这个值并在脚本中使用。

Linux 提供了专门的变量 `$?` 来保存最后一个已执行命令的退出状态码。
对于需要进行检查的命令，必须在其运行完毕后立刻查看或使用 `$?` 变量。
这是因为该变量的值会随时变成由 shell 所执行的最后一个命令的退出状态码：

```
$ date
2024年 08月 06日 星期二 11:18:28 CST
$ echo $?
0
$
```

按照惯例，对于成功结束的命令，其退出状态码是 0。对于因错误而结束的命令，
其退出状态码是一个正整数：

```
$ asdfgsd
asdfgsd：未找到命令
$ echo $?
127
$
```

无效命令会返回退出状态码 127。Linux 错误退出状态码没有什么标准可循。
但有一些可用的指南：

| 状 态 码 | 描 述                          |
| -------- | ------------------------------ |
| 0        | 命令成功结束                   |
| 1        | 一般性未知错误                 |
| 2        | 不适合的 shell 命令            |
| 126      | 命令无法执行                   |
| 127      | 没找到命令                     |
| 128      | 无效的退出参数                 |
| 128+x    | 与 Linux 信号 x 相关的严重错误 |
| 130      | 通过 Ctrl+C 终止的命令         |
| 255      | 正常范围之外的退出状态码       |

退出状态码 126 表明用户没有执行命令的正确权限：

```
$ ./a.c
bash: ./a.c: 权限不够
$ echo $?
126
```

另一个你会碰到的常见错误是给命令提供了无效参数：

```
$ date %t
date: 无效的日期"%t"
$ echo $?
1
$
```

这会产生一般性的退出状态码 1，表明在命令中发生了未知错误。

在默认情况下，shell 脚本会以脚本中的最后一个命令的退出状态码退出：

```bash
#!/bin/bash
# An example of using the expr command

var1=10
var2=20
var3=$(expr $var2 / $var1)
echo The result is $var3
```

运行这个脚本时，会产生如下输出：

```
$ ./10-expr-command-math
The result is 2
$ echo $?
0
$
```

你可以改变这种默认行为，返回自己的退出状态码。
exit 命令允许在脚本结束时指定一个退出状态码：

```bash
#!/bin/bash
#testing exit status

var1=10
var2=30
var3=$[$var1 + $var2]
echo The answer is $var3
exit 5
```

当你检查脚本的退出状态码时，就会看到传给 exit 命令的参数值：

```
$ ./16-testing-exit-status
The answer is 40
$ echo $?
5
$
```

也可以使用变量作为 exit 命令的参数：

```bash
#!/bin/bash
# testing the exit status
var1=10
var2=20
var3=$[$var1 + $var2]
exit $var3
```

运行这个脚本时，会产生如下退出状态码：

```
$ ./17-exit-with-variable
$ echo $?
30
$
```

使用这个功能时要小心，因为退出状态码最大只能是 255。
来看下面这个例子：

```bash
#!/bin/bash
# testing the exit status
var1=10
var2=30
var3=$[$var1 * $var2]
exit $var3
```

现在运行它会得到如下输出：

```
$ ./17-exit-with-variable
$ echo $?
44
$
```

退出状态码被缩减到了 0～255 的区间。shell 通过模运算得到这个结果。
一个值的模就是被除后的余数。最终的结果是指定的数值除以 256 后得到的余数。
在这个例子中，指定的值是 300 （返回值），余数是 44，因此这个余数就成了最后的退出状态码。


### 参考资料:
- 《Linux命令行与shell脚本编程大全（第4版）》: 11.8 退出脚本
